<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Bluevia: OAuth API guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="blv_php_oauth_guide">OAuth API guide </a></h1><p>BlueVia APIs require authentication for applications to get information and send data. Normally, an application is acting on behalf of a final user, so both the user and your application must be identified and authenticated. You can get full information about it at <a href="https://bluevia.com/en/knowledge/getStarted.Authentication">Bluevia OAuth guide</a></p>
<h2><a class="anchor" id="oauth_authenticating_sec">
Authenticating with BlueVia OAuth</a></h2>
<p>Most of requests when accessing Bluevia API are associated to a specific user, so when a <a class="el" href="class_bluevia_client.html">BlueviaClient</a> object is created both user token and user token secret must be provided to identify user on behalf of whom the application wants to access BlueVia APIs.</p>
<p>To get the users authorization for using BlueVia API's on their behalf, you have to do the following.</p>
<h3><a class="anchor" id="oauth_request_token_subsec">
Get your request token for starting the process</a></h3>
<p>The first step after getting your API keys is to obtain a valid request token that is required to start the OAuth process. In order to get that valid token, you must call the getRequestToken function with the API keys as mandatory parameters. If you provide a callback URL the optional third parameter, the SDK would redirect your application to that URL after getting the valid request token from the server. In that case you would not need to keep the returning value of the getRequestToken function as the SDK would do that for you, storing that value as a cookie. In other case, if you do not enter the callback URL as third parameter, you must keep the getRequestToken returning value (a <a href="http://zendframeworkdocumentation.com/classZend__Oauth__Token__Request.html">Zend_Oauth_Token_Request object</a>) in order to continue the OAuth process.</p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">try</span>{
        $request_token = $oauth-&gt;getRequestToken(<span class="stringliteral">&#39;xxxxxxxxxxxx&#39;</span>,<span class="stringliteral">&#39;xxxxxxxxxxxxx&#39;</span>,<span class="stringliteral">&#39;http://callbackuri&#39;</span>);
}
<span class="keywordflow">catch</span>(Exception $e){
        print <span class="stringliteral">&quot;Exception: &quot;</span>.$e-&gt;getMessage();
}
</pre></div><h3><a class="anchor" id="oauth_authorise_subsec">
Take the user to BlueVia Connect</a></h3>
<p>In order to get user authorization using the oauth_token obtained from your previous call to the getRequestToken() function, your application must take the user to BlueVia Connect including the oauth_token as a request parameter. If you are using the autoredirect option, the library will automatically point the user to the correct authorization URL. In other case, you would have to manually redirect your application to the BlueVia Connect authorization site with the oauth_token as request parameter, this way: </p>
<div class="fragment"><pre class="fragment">https:<span class="comment">//connect.bluevia.com/authorise?oauth_token=xxxxxxxxxxxxxxxxx</span>
</pre></div><p> Once the user confirms the authorization, depending on which method you have used (automatic or manual redirection), you would receive the oauth_verifier as a request parameter at your application URL (<a href="http://callbackuri/?oauth_verifier=111111&oauth_token=xxxxxxxxxxxxxxxxxxxx">http://callbackuri/?oauth_verifier=111111&amp;oauth_token=xxxxxxxxxxxxxxxxxxxx</a>) or you would have to provide a way to let the user enter in your application the verification code that he must have keep as the PIN Code Activation Details parameter from the successfully activated app services page.</p>
<h3><a class="anchor" id="oauth_obtain_access_token">
Obtain the access token</a></h3>
<p>Once you have the verification code and optionally,depending of the redirection method you have chosen, the verified token, you may call the getAccessToken function to obtain the final valid access token to start using the rest of BlueVia APIs. The following example will show you how to obtain the access token using the autoredirection mode. </p>
<div class="fragment"><pre class="fragment"><span class="comment">// oauth_verifier must be provided as a URL request parameter</span>
$oauth_verifier = $_GET[<span class="stringliteral">&#39;oauth_verifier&#39;</span>];
<span class="keywordflow">try</span> {
        <span class="comment">// Note that in this case, the request token would be taken from the cookie that</span>
        <span class="comment">// has previously stored by the library.</span>
        $access_token = $oauth-&gt;getAccessToken($oauth_verifier, CONSUMER_KEY, CONSUMER_SECRET);
        <span class="keywordflow">if</span>($access_token) var_dump($access_token);
} <span class="keywordflow">catch</span> (Exception $e) {
        print <span class="stringliteral">&quot;Exception: &quot;</span>.$e-&gt;getMessage();
}
</pre></div><p> Using the accessToken you can get the token_secret and token required to perform authorized API requests. </p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">if</span> (is_object($returned[<span class="stringliteral">&#39;ACCESS_TOKEN&#39;</span>])) {
     $token_secret = $returned[<span class="stringliteral">&#39;ACCESS_TOKEN&#39;</span>]-&gt;getParam(<span class="stringliteral">&#39;oauth_token_secret&#39;</span>);
     $token = $returned[<span class="stringliteral">&#39;ACCESS_TOKEN&#39;</span>]-&gt;getParam(<span class="stringliteral">&#39;oauth_token&#39;</span>);
}
</pre></div><p> The following example will show how to obtain the access token providing the verification code and the request token parameters. </p>
<div class="fragment"><pre class="fragment">$request_token = <span class="keyword">new</span> Zend_Oauth_Token_Request();
$request_token-&gt;setParams(array(
                        <span class="stringliteral">&#39;oauth_callback_confirmed&#39;</span> =&gt; <span class="stringliteral">&#39;true&#39;</span>,
                        <span class="stringliteral">&#39;oauth_token_secret&#39;</span> =&gt; <span class="stringliteral">&#39;xxxxxxxxxxxxxxxx&#39;</span>,
                        <span class="stringliteral">&#39;oauth_token&#39;</span> =&gt; <span class="stringliteral">&#39;xxxxxxxxxxxxxxxxx&#39;</span>));
<span class="keywordflow">try</span>{
        $access_token = $oauth-&gt;getAccessToken(VERIFICATION_CODE, CONSUMER_KEY, CONSUMER_SECRET,$request_token);
        <span class="keywordflow">if</span>($access_token) var_dump($access_token);
} <span class="keywordflow">catch</span> (Exception $e) {
        print <span class="stringliteral">&quot;Exception: &quot;</span>.$e-&gt;getMessage();
}
</pre></div><p> The returning $access_token value will be an array containing the request token as a <a href="http://zendframeworkdocumentation.com/classZend__Oauth__Token__Request.html">Zend_Oauth_Token_Request</a>, the access token as a <a href="http://zendframeworkdocumentation.com/classZend__Oauth__Token__Access.html">Zend_Oauth_Token_Access</a> and the instance of the used HTTP client as a <a href="http://zendframeworkdocumentation.com/classZend__Http__Client.html">Zend_Http_Client</a>.</p>
<h2><a class="anchor" id="oauth_making_authorized_request_sec">
Making an authorized API request</a></h2>
<p>Once your have obtained the user access token, you will be ready to use it on the Unica object that will be your BlueVia API's client.</p>
<p>To associate the access token and include the Authorization header for that user you have to do the following: </p>
<div class="fragment"><pre class="fragment">application_context = array(
    <span class="stringliteral">&#39;user&#39;</span> =&gt; array(
        <span class="stringliteral">&#39;token_access&#39;</span> =&gt; $token,
        <span class="stringliteral">&#39;token_secret&#39;</span> =&gt; $token_secret,
    ),
    <span class="stringliteral">&#39;app&#39;</span> =&gt; array(
        <span class="stringliteral">&#39;consumer_key&#39;</span> =&gt; CONSUMER_KEY,
        <span class="stringliteral">&#39;consumer_secret&#39;</span> =&gt; CONSUMER_SECRET        
    )
);
$bv = <span class="keyword">new</span> <a class="code" href="class_bluevia_client.html">BlueviaClient</a>($application_context);
</pre></div><p>When you make an authorized API request the following exceptions may be thrown: </p>
<ul>
<li>
<b><a class="el" href="class_bluevia_client___exception___parameters.html">BlueviaClient_Exception_Parameters</a></b>: thrown when some expected parameters are missing. </li>
<li>
<b><a class="el" href="class_bluevia_client___exception___response.html">BlueviaClient_Exception_Response</a></b>: thrown when response has an error. </li>
<li>
<b><a class="el" href="class_bluevia_client___exception___client.html">BlueviaClient_Exception_Client</a></b>: thrown when a generic client error ocurres. </li>
<li>
<b><a class="el" href="class_bluevia_client___exception___server.html">BlueviaClient_Exception_Server</a></b>: thrown when the server returns an error </li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue Aug 30 21:02:06 2011 for Bluevia by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
